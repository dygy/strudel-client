---
// Dedicated login page with proper internationalization
// Static page - no server-side rendering needed
export const prerender = true;

import HeadCommon from '../components/HeadCommon.astro';

// For static builds, we'll handle URL parameters on the client side
// No server-side URL parsing needed
---

<html lang="en">
<head>
    <HeadCommon />
    <title>Sign In - Strudel REPL</title>
    <!-- Use proper favicon files -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/icon.png">
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .logo img {
            width: 32px;
            height: 32px;
        }
        .language-selector {
            position: relative;
        }
        .language-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .language-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 6px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            min-width: 150px;
            display: none;
            z-index: 10;
        }
        .language-dropdown.show {
            display: block;
        }
        .language-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }
        .language-option:last-child {
            border-bottom: none;
        }
        .language-option:hover {
            background: #f9fafb;
        }
        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            text-align: center;
            color: #1a1a1a;
        }
        .auth-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #4285f4;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s;
            margin: 0.5rem;
        }
        .auth-button:hover {
            background: #3367d6;
        }
        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="/logo.svg" alt="Strudel Logo" />
            <span data-i18n="title">Strudel</span>
        </div>
        
        <div class="language-selector">
            <button class="language-button" onclick="toggleLanguageDropdown()">
                <span id="current-language">English</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6"/>
                </svg>
            </button>
            <div class="language-dropdown" id="language-dropdown">
                <div class="language-option" onclick="setLanguage('en', 'English')">üá∫üá∏ English</div>
                <div class="language-option" onclick="setLanguage('es', 'Espa√±ol')">üá™üá∏ Espa√±ol</div>
                <div class="language-option" onclick="setLanguage('fr', 'Fran√ßais')">üá´üá∑ Fran√ßais</div>
                <div class="language-option" onclick="setLanguage('ru', '–†—É—Å—Å–∫–∏–π')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</div>
                <div class="language-option" onclick="setLanguage('ar', 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©')">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</div>
                <div class="language-option" onclick="setLanguage('he', '◊¢◊ë◊®◊ô◊™')">üáÆüá± ◊¢◊ë◊®◊ô◊™</div>
                <div class="language-option" onclick="setLanguage('sr', '–°—Ä–ø—Å–∫–∏')">üá∑üá∏ –°—Ä–ø—Å–∫–∏</div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="auth-card">
            <div style="margin-bottom: 2rem;">
                <img src="/logo.svg" alt="Strudel Logo" width="64" height="64" style="margin: 0 auto 1rem; color: #667eea;" />
                <h1 style="margin: 0 0 0.5rem; font-size: 2rem; font-weight: bold;" data-i18n="welcome-title">Welcome to Strudel</h1>
                <p style="margin: 0; color: #6b7280;" data-i18n="welcome-subtitle">Live coding environment for musical patterns</p>
            </div>
            
            <div id="error-container" style="display: none;">
              <div class="error-message">
                <span data-i18n="error-prefix">Authentication issue:</span> <span id="error-text"></span>. <span data-i18n="error-suffix">Please sign in again.</span>
              </div>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <p id="description-text" style="margin: 0 0 1rem; color: #374141;" data-i18n="sign-in-description">
                  Sign in to sync your tracks across devices and access cloud features.
                </p>
                
                <button class="auth-button" onclick="signInWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span data-i18n="sign-in-button">Continue with Google</span>
                </button>
            </div>
            
            <p style="margin: 0; font-size: 0.875rem; color: #6b7280;" data-i18n="sign-in-footer">
                Sign in to access all features and sync your tracks to the cloud.
            </p>
        </div>
    </div>
    
    <script type="module">
        // Import translations from the existing auth.json files
        const translations = {
            en: {
                'title': 'Strudel',
                'welcome-title': 'Welcome to Strudel',
                'welcome-subtitle': 'Live coding environment for musical patterns',
                'error-prefix': 'Authentication issue:',
                'error-suffix': 'Please sign in again.',
                'track-access-description': 'Sign in to access this shared track and sync your music across devices.',
                'sign-in-description': 'Sign in to sync your tracks across devices and access cloud features.',
                'sign-in-button': 'Continue with Google',
                'sign-in-footer': 'Sign in to access all features and sync your tracks to the cloud.'
            },
            es: {
                'title': 'Strudel',
                'welcome-title': 'Bienvenido a Strudel',
                'welcome-subtitle': 'Entorno de codificaci√≥n en vivo para patrones musicales',
                'error-prefix': 'Problema de autenticaci√≥n:',
                'error-suffix': 'Por favor, inicia sesi√≥n de nuevo.',
                'track-access-description': 'Inicia sesi√≥n para acceder a esta pista compartida y sincronizar tu m√∫sica en todos los dispositivos.',
                'sign-in-description': 'Inicia sesi√≥n para sincronizar tus pistas en todos los dispositivos y acceder a las funciones de la nube.',
                'sign-in-button': 'Continuar con Google',
                'sign-in-footer': 'Inicia sesi√≥n para acceder a todas las funciones y sincronizar tus pistas en la nube.'
            },
            fr: {
                'title': 'Strudel',
                'welcome-title': 'Bienvenue sur Strudel',
                'welcome-subtitle': 'Environnement de codage en direct pour les motifs musicaux',
                'error-prefix': 'Probl√®me d\'authentification:',
                'error-suffix': 'Veuillez vous reconnecter.',
                'track-access-description': 'Connectez-vous pour acc√©der √† cette piste partag√©e et synchroniser votre musique sur tous vos appareils.',
                'sign-in-description': 'Connectez-vous pour synchroniser vos pistes sur tous vos appareils et acc√©der aux fonctionnalit√©s cloud.',
                'sign-in-button': 'Continuer avec Google',
                'sign-in-footer': 'Connectez-vous pour acc√©der √† toutes les fonctionnalit√©s et synchroniser vos pistes dans le cloud.'
            },
            ru: {
                'title': 'Strudel',
                'welcome-title': '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Strudel',
                'welcome-subtitle': '–°—Ä–µ–¥–∞ –∂–∏–≤–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤',
                'error-prefix': '–ü—Ä–æ–±–ª–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:',
                'error-suffix': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.',
                'track-access-description': '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É –æ–±—â–µ–º—É —Ç—Ä–µ–∫—É –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º—É–∑—ã–∫—É –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.',
                'sign-in-description': '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫–∏ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –æ–±–ª–∞—á–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º.',
                'sign-in-button': '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å Google',
                'sign-in-footer': '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫–∏ –≤ –æ–±–ª–∞–∫–µ.'
            },
            ar: {
                'title': 'Strudel',
                'welcome-title': 'ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä Strudel',
                'welcome-subtitle': 'ÿ®Ÿäÿ¶ÿ© ÿßŸÑÿ®ÿ±ŸÖÿ¨ÿ© ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÑŸÑÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸäÿ©',
                'error-prefix': 'ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑŸÖÿµÿßÿØŸÇÿ©:',
                'error-suffix': 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.',
                'track-access-description': 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑŸÖÿ¥ÿ™ÿ±ŸÉ ŸàŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖŸàÿ≥ŸäŸÇÿßŸÉ ÿπÿ®ÿ± ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©.',
                'sign-in-description': 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿ≥ÿßÿ±ÿßÿ™ŸÉ ÿπÿ®ÿ± ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ŸàÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©.',
                'sign-in-button': 'ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ© ŸÖÿπ Google',
                'sign-in-footer': 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸäÿ≤ÿßÿ™ ŸàŸÖÿ≤ÿßŸÖŸÜÿ© ŸÖÿ≥ÿßÿ±ÿßÿ™ŸÉ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©.'
            },
            he: {
                'title': 'Strudel',
                'welcome-title': '◊ë◊®◊ï◊õ◊ô◊ù ◊î◊ë◊ê◊ô◊ù ◊ú-Strudel',
                'welcome-subtitle': '◊°◊ë◊ô◊ë◊™ ◊ß◊ô◊ì◊ï◊ì ◊ó◊ô ◊ú◊ì◊§◊ï◊°◊ô◊ù ◊û◊ï◊ñ◊ô◊ß◊ú◊ô◊ô◊ù',
                'error-prefix': '◊ë◊¢◊ô◊ô◊™ ◊ê◊ô◊û◊ï◊™:',
                'error-suffix': '◊ê◊†◊ê ◊î◊™◊ó◊ë◊® ◊©◊ï◊ë.',
                'track-access-description': '◊î◊™◊ó◊ë◊® ◊õ◊ì◊ô ◊ú◊í◊©◊™ ◊ú◊®◊¶◊ï◊¢◊î ◊î◊û◊©◊ï◊™◊§◊™ ◊î◊ñ◊ï ◊ï◊ú◊°◊†◊õ◊®◊ü ◊ê◊™ ◊î◊û◊ï◊ñ◊ô◊ß◊î ◊©◊ú◊ö ◊ë◊ô◊ü ◊î◊û◊õ◊©◊ô◊®◊ô◊ù.',
                'sign-in-description': '◊î◊™◊ó◊ë◊® ◊õ◊ì◊ô ◊ú◊°◊†◊õ◊®◊ü ◊ê◊™ ◊î◊®◊¶◊ï◊¢◊ï◊™ ◊©◊ú◊ö ◊ë◊ô◊ü ◊î◊û◊õ◊©◊ô◊®◊ô◊ù ◊ï◊ú◊í◊©◊™ ◊ú◊™◊õ◊ï◊†◊ï◊™ ◊î◊¢◊†◊ü.',
                'sign-in-button': '◊î◊û◊©◊ö ◊¢◊ù Google',
                'sign-in-footer': '◊î◊™◊ó◊ë◊® ◊õ◊ì◊ô ◊ú◊í◊©◊™ ◊ú◊õ◊ú ◊î◊™◊õ◊ï◊†◊ï◊™ ◊ï◊ú◊°◊†◊õ◊®◊ü ◊ê◊™ ◊î◊®◊¶◊ï◊¢◊ï◊™ ◊©◊ú◊ö ◊ë◊¢◊†◊ü.'
            },
            sr: {
                'title': 'Strudel',
                'welcome-title': '–î–æ–±—Ä–æ–¥–æ—à–ª–∏ —É Strudel',
                'welcome-subtitle': '–û–∫—Ä—É–∂–µ—ö–µ –∑–∞ –∂–∏–≤–æ –∫–æ–¥–∏—Ä–∞—ö–µ –º—É–∑–∏—á–∫–∏—Ö –æ–±—Ä–∞–∑–∞—Ü–∞',
                'error-prefix': '–ü—Ä–æ–±–ª–µ–º —Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—ò–æ–º:',
                'error-suffix': '–ú–æ–ª–∏–º–æ –ø—Ä–∏—ò–∞–≤–∏—Ç–µ —Å–µ –ø–æ–Ω–æ–≤–æ.',
                'track-access-description': '–ü—Ä–∏—ò–∞–≤–∏—Ç–µ —Å–µ –¥–∞ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç–µ –æ–≤–æ—ò –¥–µ—ô–µ–Ω–æ—ò –Ω—É–º–µ—Ä–∏ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑—É—ò–µ—Ç–µ –º—É–∑–∏–∫—É –Ω–∞ —Å–≤–∏–º —É—Ä–µ—í–∞—ò–∏–º–∞.',
                'sign-in-description': '–ü—Ä–∏—ò–∞–≤–∏—Ç–µ —Å–µ –¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑—É—ò–µ—Ç–µ –Ω—É–º–µ—Ä–µ –Ω–∞ —Å–≤–∏–º —É—Ä–µ—í–∞—ò–∏–º–∞ –∏ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—ò–∞–º–∞ –æ–±–ª–∞–∫–∞.',
                'sign-in-button': '–ù–∞—Å—Ç–∞–≤–∏ —Å–∞ Google',
                'sign-in-footer': '–ü—Ä–∏—ò–∞–≤–∏—Ç–µ —Å–µ –¥–∞ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç–µ —Å–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—ò–∞–º–∞ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑—É—ò–µ—Ç–µ –Ω—É–º–µ—Ä–µ —É –æ–±–ª–∞–∫—É.'
            }
        };

        // TODO: Replace hardcoded translations with dynamic loading from auth.json files
        // This is a temporary solution - ideally we should load from:
        // /src/i18n/locales/{lang}/auth.json files

        // Language names mapping
        const languageNames = {
            'en': 'English',
            'es': 'Espa√±ol', 
            'fr': 'Fran√ßais',
            'ru': '–†—É—Å—Å–∫–∏–π',
            'ar': 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
            'he': '◊¢◊ë◊®◊ô◊™',
            'sr': '–°—Ä–ø—Å–∫–∏'
        };

        let currentLanguage = 'en';

        // Handle URL parameters on client side
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            const hasTrack = urlParams.has('track');
            
            // Show error if present
            if (error) {
                document.getElementById('error-text').textContent = error;
                document.getElementById('error-container').style.display = 'block';
            }
            
            // Update description based on track parameter
            if (hasTrack) {
                const descriptionElement = document.getElementById('description-text');
                descriptionElement.setAttribute('data-i18n', 'track-access-description');
                // Apply current language translation
                applyTranslations(currentLanguage);
            }
        }

        // Apply translations
        function applyTranslations(lang) {
            const langTranslations = translations[lang] || translations.en;
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (langTranslations[key]) {
                    element.textContent = langTranslations[key];
                }
            });
            
            // Set document direction for RTL languages
            if (lang === 'ar' || lang === 'he') {
                document.documentElement.dir = 'rtl';
                document.documentElement.classList.add('rtl');
            } else {
                document.documentElement.dir = 'ltr';
                document.documentElement.classList.remove('rtl');
            }
            
            document.documentElement.lang = lang;
        }

        async function signInWithGoogle() {
            try {
                // Store redirect URL if we have track parameter
                const urlParams = new URLSearchParams(window.location.search);
                const trackId = urlParams.get('track');
                if (trackId) {
                    sessionStorage.setItem('strudel_redirect_after_auth', `/repl?track=${trackId}`);
                } else {
                    sessionStorage.setItem('strudel_redirect_after_auth', '/repl');
                }
                
                const { supabase } = await import('/src/lib/supabase.ts');
                
                console.log('=== SIGN IN WITH GOOGLE DEBUG ===');
                const currentOrigin = window.location.origin;
                const callbackUrl = currentOrigin + '/auth/callback';
                console.log('Current origin:', currentOrigin);
                console.log('Callback URL:', callbackUrl);
                console.log('Starting OAuth flow...');
                
                // Use the standard Supabase auth method
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: callbackUrl
                    }
                });
                
                console.log('OAuth result:', { data, error });
                console.log('=== END SIGN IN WITH GOOGLE DEBUG ===');
                
                if (error) {
                    console.error('Sign in error:', error);
                    alert('Sign in failed: ' + error.message);
                }
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed. Please try again.');
            }
        }
        
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('language-dropdown');
            dropdown.classList.toggle('show');
        }
        
        function setLanguage(code, name) {
            currentLanguage = code;
            document.getElementById('current-language').textContent = name;
            document.getElementById('language-dropdown').classList.remove('show');
            
            // Store language preference
            localStorage.setItem('strudel-language', code);
            
            // Apply translations
            applyTranslations(code);
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const selector = document.querySelector('.language-selector');
            if (!selector.contains(event.target)) {
                document.getElementById('language-dropdown').classList.remove('show');
            }
        });
        
        // Load saved language preference and apply translations
        const savedLanguage = localStorage.getItem('strudel-language') || 'en';
        if (languageNames[savedLanguage]) {
            currentLanguage = savedLanguage;
            document.getElementById('current-language').textContent = languageNames[savedLanguage];
            applyTranslations(savedLanguage);
        }
        
        // Handle URL parameters after page load
        handleUrlParameters();
        
        // Make functions global
        window.signInWithGoogle = signInWithGoogle;
        window.toggleLanguageDropdown = toggleLanguageDropdown;
        window.setLanguage = setLanguage;
    </script>
</body>
</html>