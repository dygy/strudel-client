---
// Main REPL page with SSR data for authenticated users
import HeadCommon from '../components/HeadCommon.astro';
import { Repl } from '../repl/Repl';
import { I18nProvider } from '../components/I18nProvider';
import { createClient } from '@supabase/supabase-js';
import { TreeDataTransformer } from '../lib/TreeDataTransformer';

import type { SSRData } from '../types/ssr';

export const prerender = false; // Enable SSR for authenticated data

// SSR data fetching for authenticated users
let ssrData: SSRData | null = null;

try {
  // Get access token from cookies
  const accessToken = Astro.cookies.get('sb-access-token')?.value;
  
  if (accessToken) {
    console.log('REPL SSR - Access token found, fetching user data...');
    
    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
    const supabaseServiceKey = import.meta.env.SUPABASE_SERVICE_ROLE_KEY;
    
    if (supabaseUrl && supabaseServiceKey && !supabaseUrl.includes('placeholder')) {
      const supabase = createClient(supabaseUrl, supabaseServiceKey);
      
      // Verify the user token
      const { data: { user }, error: userError } = await supabase.auth.getUser(accessToken);
      
      if (user && !userError) {
        console.log('REPL SSR - User verified:', user.id);
        
        // Get tracks from database
        const { data: tracksData, error: tracksError } = await supabase
          .from('tracks')
          .select('*')
          .eq('user_id', user.id)
          .order('modified', { ascending: false });

        // Get folders from database  
        const { data: foldersData, error: foldersError } = await supabase
          .from('folders')
          .select('*')
          .eq('user_id', user.id)
          .order('created', { ascending: true });

        if (!tracksError && !foldersError) {
          // Convert to expected format
          const tracks = (tracksData || []).map(track => ({
            id: track.id,
            name: track.name,
            code: track.code || '',
            created: track.created,
            modified: track.modified,
            folder: track.folder,
            isMultitrack: track.is_multitrack || false,
            steps: track.steps || [],
            activeStep: track.active_step || 0,
            user_id: track.user_id,
          }));

          const folders = (foldersData || []).map(folder => ({
            id: folder.id,
            name: folder.name,
            path: folder.path,
            parent: folder.parent,
            created: folder.created,
            user_id: folder.user_id,
          }));

          // Transform to hierarchical tree structure for tracksStore
          const tree = TreeDataTransformer.transformToTree(tracks, folders);
          
          // Provide both formats for compatibility
          ssrData = {
            // Flat format for useSupabaseFileManager
            tracks,
            folders,
            // Hierarchical format for tracksStore
            hierarchical: tree.root
          };
          
          console.log('REPL SSR - Data loaded successfully:', {
            tracksCount: tracks.length,
            foldersCount: folders.length,
            format: 'both'
          });
        } else {
          console.error('REPL SSR - Database error:', tracksError || foldersError);
        }
      } else {
        console.log('REPL SSR - User verification failed:', userError?.message || 'No user');
      }
    } else {
      console.log('REPL SSR - Supabase not configured properly');
    }
  } else {
    console.log('REPL SSR - No access token found');
  }
} catch (error) {
  console.error('REPL SSR - Error fetching data:', error);
}
---

<html lang="en" class="m-0 dark">
  <head>
    <HeadCommon />
    <title>Strudel REPL</title>
  </head>
  <body class="h-app-height bg-background m-0">
    <I18nProvider client:only="react">
      <Repl client:only="react" ssrData={ssrData} />
    </I18nProvider>
  </body>
</html>
